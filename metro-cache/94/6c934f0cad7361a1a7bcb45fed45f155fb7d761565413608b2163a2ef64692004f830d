{"dependencies":[{"name":"@babel/runtime/helpers/interopRequireDefault","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0},"end":{"line":196,"column":0}},{"start":{"line":1,"column":0},"end":{"line":196,"column":0}},{"start":{"line":1,"column":0},"end":{"line":196,"column":0}},{"start":{"line":18,"column":0},"end":{"line":18,"column":86}},{"start":{"line":19,"column":0},"end":{"line":19,"column":58}}]}},{"name":"@babel/runtime/regenerator","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0},"end":{"line":196,"column":0}}]}},{"name":"@babel/runtime/helpers/classCallCheck","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0},"end":{"line":196,"column":0}}]}},{"name":"@babel/runtime/helpers/createClass","data":{"asyncType":null,"locs":[{"start":{"line":1,"column":0},"end":{"line":196,"column":0}}]}},{"name":"@react-native-firebase/app/lib/internal/NativeFirebaseError","data":{"asyncType":null,"locs":[{"start":{"line":18,"column":0},"end":{"line":18,"column":86}}]}},{"name":"./FirestoreTransaction","data":{"asyncType":null,"locs":[{"start":{"line":19,"column":0},"end":{"line":19,"column":58}}]}}],"output":[{"data":{"code":"__d(function (global, _$$_REQUIRE, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.default = void 0;\n\n  var _regenerator = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\")(_$$_REQUIRE(_dependencyMap[1], \"@babel/runtime/regenerator\"));\n\n  var _classCallCheck2 = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\")(_$$_REQUIRE(_dependencyMap[2], \"@babel/runtime/helpers/classCallCheck\"));\n\n  var _createClass2 = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\")(_$$_REQUIRE(_dependencyMap[3], \"@babel/runtime/helpers/createClass\"));\n\n  var _NativeFirebaseError = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\")(_$$_REQUIRE(_dependencyMap[4], \"@react-native-firebase/app/lib/internal/NativeFirebaseError\"));\n\n  var _FirestoreTransaction = _$$_REQUIRE(_dependencyMap[0], \"@babel/runtime/helpers/interopRequireDefault\")(_$$_REQUIRE(_dependencyMap[5], \"./FirestoreTransaction\"));\n\n  var transactionId = 0;\n\n  var generateTransactionId = function generateTransactionId() {\n    return transactionId++;\n  };\n\n  var FirestoreTransactionHandler = function () {\n    function FirestoreTransactionHandler(firestore) {\n      (0, _classCallCheck2.default)(this, FirestoreTransactionHandler);\n      this._firestore = firestore;\n      this._pending = {};\n\n      this._firestore.emitter.addListener(this._firestore.eventNameForApp('firestore_transaction_event'), this._onTransactionEvent.bind(this));\n    }\n\n    (0, _createClass2.default)(FirestoreTransactionHandler, [{\n      key: \"_onTransactionEvent\",\n      value: function _onTransactionEvent(event) {\n        switch (event.body.type) {\n          case 'update':\n            this._handleUpdate(event);\n\n            break;\n\n          case 'error':\n            this._handleError(event);\n\n            break;\n\n          case 'complete':\n            this._handleComplete(event);\n\n            break;\n        }\n      }\n    }, {\n      key: \"_handleUpdate\",\n      value: function _handleUpdate(event) {\n        var id, _this$_pending$id, meta, transaction, updateFunction, reject, finalError, updateFailed, pendingResult, possiblePromise;\n\n        return _regenerator.default.async(function _handleUpdate$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                id = event.listenerId;\n\n                if (this._pending[id]) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", this._remove(id));\n\n              case 3:\n                _this$_pending$id = this._pending[id], meta = _this$_pending$id.meta, transaction = _this$_pending$id.transaction;\n                updateFunction = meta.updateFunction, reject = meta.reject;\n\n                transaction._prepare();\n\n                _context.prev = 6;\n                possiblePromise = updateFunction(transaction);\n\n                if (!(!possiblePromise || !possiblePromise.then)) {\n                  _context.next = 10;\n                  break;\n                }\n\n                throw new Error(\"firebase.firestore().runTransaction(*) 'updateFunction' must return a Promise.\");\n\n              case 10:\n                _context.next = 12;\n                return _regenerator.default.awrap(possiblePromise);\n\n              case 12:\n                pendingResult = _context.sent;\n                _context.next = 19;\n                break;\n\n              case 15:\n                _context.prev = 15;\n                _context.t0 = _context[\"catch\"](6);\n                updateFailed = true;\n                finalError = _context.t0;\n\n              case 19:\n                if (!(updateFailed || finalError)) {\n                  _context.next = 21;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", reject(finalError));\n\n              case 21:\n                transaction._pendingResult = pendingResult;\n                return _context.abrupt(\"return\", this._firestore.native.transactionApplyBuffer(id, transaction._commandBuffer));\n\n              case 23:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, null, this, [[6, 15]], Promise);\n      }\n    }, {\n      key: \"_handleError\",\n      value: function _handleError(event) {\n        var id = event.listenerId,\n            body = event.body;\n        var error = body.error;\n\n        if (!this._pending[id]) {\n          return;\n        }\n\n        var meta = this._pending[id].meta;\n\n        if (meta && error) {\n          var errorAndStack = _NativeFirebaseError.default.fromEvent(error, 'firestore', meta.stack);\n\n          meta.reject(errorAndStack);\n        }\n      }\n    }, {\n      key: \"_handleComplete\",\n      value: function _handleComplete(event) {\n        var id = event.listenerId;\n\n        if (!this._pending[id]) {\n          return;\n        }\n\n        var _this$_pending$id2 = this._pending[id],\n            meta = _this$_pending$id2.meta,\n            transaction = _this$_pending$id2.transaction;\n\n        if (meta) {\n          meta.resolve(transaction._pendingResult);\n        }\n      }\n    }, {\n      key: \"_add\",\n      value: function _add(updateFunction) {\n        var _this = this;\n\n        var id = generateTransactionId();\n        var meta = {\n          id: id,\n          updateFunction: updateFunction,\n          stack: new Error().stack.split('\\n').slice(2).join('\\n')\n        };\n        this._pending[id] = {\n          meta: meta,\n          transaction: new _FirestoreTransaction.default(this._firestore, meta)\n        };\n        return new Promise(function (resolve, reject) {\n          _this._firestore.native.transactionBegin(id);\n\n          meta.resolve = function (result) {\n            _this._remove(id);\n\n            resolve(result);\n          };\n\n          meta.reject = function (error) {\n            _this._remove(id);\n\n            reject(error);\n          };\n        });\n      }\n    }, {\n      key: \"_remove\",\n      value: function _remove(id) {\n        this._firestore.native.transactionDispose(id);\n\n        delete this._pending[id];\n      }\n    }]);\n    return FirestoreTransactionHandler;\n  }();\n\n  exports.default = FirestoreTransactionHandler;\n});","lineCount":199,"map":[[13,0,18,0],[15,0,19,0],[17,0,21,0],[17,6,21,4,"transactionId"],[17,19,21,17],[17,22,21,20],[17,23,21,0],[19,0,28,0],[19,6,28,6,"generateTransactionId"],[19,27,28,27],[19,30,28,30],[19,39,28,6,"generateTransactionId"],[19,60,28,30],[20,0,28,30],[20,11,28,36,"transactionId"],[20,24,28,49],[20,26,28,30],[21,0,28,30],[21,3,28,0],[23,6,30,21,"FirestoreTransactionHandler"],[23,33],[24,0,31,2],[24,41,31,14,"firestore"],[24,50,31,2],[24,52,31,25],[25,0,31,25],[26,0,32,4],[26,11,32,9,"_firestore"],[26,21,32,4],[26,24,32,22,"firestore"],[26,33,32,4],[27,0,33,4],[27,11,33,9,"_pending"],[27,19,33,4],[27,22,33,20],[27,24,33,4],[29,0,34,4],[29,11,34,9,"_firestore"],[29,21,34,4],[29,22,34,20,"emitter"],[29,29,34,4],[29,30,34,28,"addListener"],[29,41,34,4],[29,42,35,6],[29,47,35,11,"_firestore"],[29,57,35,6],[29,58,35,22,"eventNameForApp"],[29,73,35,6],[29,74,35,38],[29,103,35,6],[29,104,34,4],[29,106,36,6],[29,111,36,11,"_onTransactionEvent"],[29,130,36,6],[29,131,36,31,"bind"],[29,135,36,6],[29,136,36,36],[29,140,36,6],[29,141,34,4],[30,0,38,3],[34,13,40,2],[34,42,40,22,"event"],[34,47,40,2],[34,49,40,29],[35,0,41,4],[35,16,41,12,"event"],[35,21,41,17],[35,22,41,18,"body"],[35,26,41,12],[35,27,41,23,"type"],[35,31,41,4],[36,0,42,6],[36,15,42,11],[36,23,42,6],[37,0,43,8],[37,17,43,13,"_handleUpdate"],[37,30,43,8],[37,31,43,27,"event"],[37,36,43,8],[39,0,44,8],[41,0,45,6],[41,15,45,11],[41,22,45,6],[42,0,46,8],[42,17,46,13,"_handleError"],[42,29,46,8],[42,30,46,26,"event"],[42,35,46,8],[44,0,47,8],[46,0,48,6],[46,15,48,11],[46,25,48,6],[47,0,49,8],[47,17,49,13,"_handleComplete"],[47,32,49,8],[47,33,49,29,"event"],[47,38,49,8],[49,0,50,8],[50,0,41,4],[51,0,52,3],[54,13,54,2],[54,36,54,22,"event"],[54,41,54,2],[55,0,54,2],[57,0,54,2],[58,0,54,2],[59,0,54,2],[60,0,54,2],[61,0,55,24,"id"],[61,16,55,24,"id"],[61,18,54,2],[61,21,55,31,"event"],[61,26,54,2],[61,27,55,12,"listenerId"],[61,37,54,2],[63,0,54,2],[63,20,58,9],[63,25,58,14,"_pending"],[63,33,58,9],[63,34,58,23,"id"],[63,36,58,9],[63,37,54,2],[64,0,54,2],[65,0,54,2],[66,0,54,2],[68,0,54,2],[68,49,59,13],[68,54,59,18,"_remove"],[68,61,59,13],[68,62,59,26,"id"],[68,64,59,13],[68,65,54,2],[70,0,54,2],[71,0,54,2],[71,36,62,34],[71,41,62,39,"_pending"],[71,49,62,34],[71,50,62,48,"id"],[71,52,62,34],[71,53,54,2],[71,55,62,12,"meta"],[71,59,54,2],[71,80,62,12,"meta"],[71,84,54,2],[71,86,62,18,"transaction"],[71,97,54,2],[71,118,62,18,"transaction"],[71,129,54,2],[72,0,63,12,"updateFunction"],[72,16,63,12,"updateFunction"],[72,30,54,2],[72,33,63,39,"meta"],[72,37,54,2],[72,38,63,12,"updateFunction"],[72,52,54,2],[72,54,63,28,"reject"],[72,60,54,2],[72,63,63,39,"meta"],[72,67,54,2],[72,68,63,28,"reject"],[72,74,54,2],[74,0,66,4,"transaction"],[74,16,66,4,"transaction"],[74,27,66,15],[74,28,66,16,"_prepare"],[74,36,66,4],[76,0,54,2],[77,0,73,12,"possiblePromise"],[77,16,73,12,"possiblePromise"],[77,31,54,2],[77,34,73,30,"updateFunction"],[77,48,73,44],[77,49,73,45,"transaction"],[77,60,73,44],[77,61,54,2],[79,0,54,2],[79,22,76,10],[79,23,76,11,"possiblePromise"],[79,38,76,10],[79,42,76,30],[79,43,76,31,"possiblePromise"],[79,58,76,46],[79,59,76,47,"then"],[79,63,54,2],[80,0,54,2],[81,0,54,2],[82,0,54,2],[84,0,54,2],[84,22,77,14],[84,26,77,18,"Error"],[84,31,77,14],[84,32,78,10],[84,112,77,14],[84,113,54,2],[86,0,54,2],[87,0,54,2],[88,0,54,2],[88,50,82,28,"possiblePromise"],[88,65,54,2],[90,0,54,2],[91,0,82,6,"pendingResult"],[91,16,82,6,"pendingResult"],[91,29,54,2],[92,0,54,2],[93,0,54,2],[95,0,54,2],[96,0,54,2],[97,0,54,2],[98,0,86,6,"updateFailed"],[98,16,86,6,"updateFailed"],[98,28,86,18],[98,31,86,21],[98,35,86,6],[99,0,87,6,"finalError"],[99,16,87,6,"finalError"],[99,26,87,16],[99,40,87,6],[101,0,54,2],[102,0,54,2],[102,22,93,8,"updateFailed"],[102,34,93,20],[102,38,93,24,"finalError"],[102,48,54,2],[103,0,54,2],[104,0,54,2],[105,0,54,2],[107,0,54,2],[107,49,94,13,"reject"],[107,55,94,19],[107,56,94,20,"finalError"],[107,66,94,19],[107,67,54,2],[109,0,54,2],[110,0,100,4,"transaction"],[110,16,100,4,"transaction"],[110,27,100,15],[110,28,100,16,"_pendingResult"],[110,42,100,4],[110,45,100,33,"pendingResult"],[110,58,100,4],[111,0,54,2],[111,49,103,11],[111,54,103,16,"_firestore"],[111,64,103,11],[111,65,103,27,"native"],[111,71,103,11],[111,72,103,34,"transactionApplyBuffer"],[111,94,103,11],[111,95,103,57,"id"],[111,97,103,11],[111,99,103,61,"transaction"],[111,110,103,72],[111,111,103,73,"_commandBuffer"],[111,125,103,11],[111,126,54,2],[113,0,54,2],[114,0,54,2],[115,0,54,2],[116,0,54,2],[117,0,54,2],[118,0,54,2],[119,0,54,2],[122,13,112,2],[122,35,112,15,"event"],[122,40,112,2],[122,42,112,22],[123,0,113,4],[123,12,113,24,"id"],[123,14,113,4],[123,17,113,37,"event"],[123,22,113,4],[123,23,113,12,"listenerId"],[123,33,113,4],[124,0,113,4],[124,12,113,28,"body"],[124,16,113,4],[124,19,113,37,"event"],[124,24,113,4],[124,25,113,28,"body"],[124,29,113,4],[125,0,114,4],[125,12,114,12,"error"],[125,17,114,4],[125,20,114,22,"body"],[125,24,114,4],[125,25,114,12,"error"],[125,30,114,4],[127,0,116,4],[127,12,116,8],[127,13,116,9],[127,18,116,14,"_pending"],[127,26,116,9],[127,27,116,23,"id"],[127,29,116,9],[127,30,116,4],[127,32,116,28],[128,0,117,6],[129,0,118,5],[131,0,120,4],[131,12,120,12,"meta"],[131,16,120,4],[131,19,120,21],[131,24,120,26,"_pending"],[131,32,120,21],[131,33,120,35,"id"],[131,35,120,21],[131,36,120,4],[131,37,120,12,"meta"],[131,41,120,4],[133,0,122,4],[133,12,122,8,"meta"],[133,16,122,12],[133,20,122,16,"error"],[133,25,122,4],[133,27,122,23],[134,0,123,6],[134,14,123,12,"errorAndStack"],[134,27,123,25],[134,30,123,28,"NativeError"],[134,59,123,40,"fromEvent"],[134,68,123,28],[134,69,123,50,"error"],[134,74,123,28],[134,76,123,57],[134,87,123,28],[134,89,123,70,"meta"],[134,93,123,74],[134,94,123,75,"stack"],[134,99,123,28],[134,100,123,6],[136,0,124,6,"meta"],[136,10,124,6,"meta"],[136,14,124,10],[136,15,124,11,"reject"],[136,21,124,6],[136,22,124,18,"errorAndStack"],[136,35,124,6],[137,0,125,5],[138,0,126,3],[141,13,135,2],[141,38,135,18,"event"],[141,43,135,2],[141,45,135,25],[142,0,136,4],[142,12,136,24,"id"],[142,14,136,4],[142,17,136,31,"event"],[142,22,136,4],[142,23,136,12,"listenerId"],[142,33,136,4],[144,0,138,4],[144,12,138,8],[144,13,138,9],[144,18,138,14,"_pending"],[144,26,138,9],[144,27,138,23,"id"],[144,29,138,9],[144,30,138,4],[144,32,138,28],[145,0,139,6],[146,0,140,5],[148,0,142,4],[148,33,142,34],[148,38,142,39,"_pending"],[148,46,142,34],[148,47,142,48,"id"],[148,49,142,34],[148,50,142,4],[149,0,142,4],[149,12,142,12,"meta"],[149,16,142,4],[149,38,142,12,"meta"],[149,42,142,4],[150,0,142,4],[150,12,142,18,"transaction"],[150,23,142,4],[150,45,142,18,"transaction"],[150,56,142,4],[152,0,143,4],[152,12,143,8,"meta"],[152,16,143,4],[152,18,143,14],[153,0,144,6,"meta"],[153,10,144,6,"meta"],[153,14,144,10],[153,15,144,11,"resolve"],[153,22,144,6],[153,23,144,19,"transaction"],[153,34,144,30],[153,35,144,31,"_pendingResult"],[153,49,144,6],[154,0,145,5],[155,0,146,3],[158,13,155,2],[158,27,155,7,"updateFunction"],[158,41,155,2],[158,43,155,23],[159,0,155,23],[161,0,156,4],[161,12,156,10,"id"],[161,14,156,12],[161,17,156,15,"generateTransactionId"],[161,38,156,36],[161,40,156,4],[162,0,158,4],[162,12,158,10,"meta"],[162,16,158,14],[162,19,158,17],[163,0,159,6,"id"],[163,10,159,6,"id"],[163,12,159,8],[163,14,159,6,"id"],[163,16,158,17],[164,0,160,6,"updateFunction"],[164,10,160,6,"updateFunction"],[164,24,160,20],[164,26,160,6,"updateFunction"],[164,40,158,17],[165,0,161,6,"stack"],[165,10,161,6,"stack"],[165,15,161,11],[165,17,161,13],[165,21,161,17,"Error"],[165,26,161,13],[165,29,161,25,"stack"],[165,34,161,13],[165,35,161,31,"split"],[165,40,161,13],[165,41,161,37],[165,45,161,13],[165,47,161,43,"slice"],[165,52,161,13],[165,53,161,49],[165,54,161,13],[165,56,161,52,"join"],[165,60,161,13],[165,61,161,57],[165,65,161,13],[166,0,158,17],[166,9,158,4],[167,0,164,4],[167,13,164,9,"_pending"],[167,21,164,4],[167,22,164,18,"id"],[167,24,164,4],[167,28,164,24],[168,0,165,6,"meta"],[168,10,165,6,"meta"],[168,14,165,10],[168,16,165,6,"meta"],[168,20,164,24],[169,0,166,6,"transaction"],[169,10,166,6,"transaction"],[169,21,166,17],[169,23,166,19],[169,27,166,23,"FirestoreTransaction"],[169,56,166,19],[169,57,166,44],[169,62,166,49,"_firestore"],[169,72,166,19],[169,74,166,61,"meta"],[169,78,166,19],[170,0,164,24],[170,9,164,4],[171,0,169,4],[171,15,169,11],[171,19,169,15,"Promise"],[171,26,169,11],[171,27,169,23],[171,37,169,24,"resolve"],[171,44,169,23],[171,46,169,33,"reject"],[171,52,169,23],[171,54,169,44],[172,0,170,6],[172,10,170,6],[172,15,170,10],[172,16,170,11,"_firestore"],[172,26,170,6],[172,27,170,22,"native"],[172,33,170,6],[172,34,170,29,"transactionBegin"],[172,50,170,6],[172,51,170,46,"id"],[172,53,170,6],[174,0,172,6,"meta"],[174,10,172,6,"meta"],[174,14,172,10],[174,15,172,11,"resolve"],[174,22,172,6],[174,25,172,21],[174,35,172,21,"result"],[174,41,172,27],[174,43,172,31],[175,0,173,8],[175,12,173,8],[175,17,173,12],[175,18,173,13,"_remove"],[175,25,173,8],[175,26,173,21,"id"],[175,28,173,8],[177,0,174,8,"resolve"],[177,12,174,8,"resolve"],[177,19,174,15],[177,20,174,16,"result"],[177,26,174,15],[177,27,174,8],[178,0,175,7],[178,11,172,6],[180,0,177,6,"meta"],[180,10,177,6,"meta"],[180,14,177,10],[180,15,177,11,"reject"],[180,21,177,6],[180,24,177,20],[180,34,177,20,"error"],[180,39,177,25],[180,41,177,29],[181,0,178,8],[181,12,178,8],[181,17,178,12],[181,18,178,13,"_remove"],[181,25,178,8],[181,26,178,21,"id"],[181,28,178,8],[183,0,179,8,"reject"],[183,12,179,8,"reject"],[183,18,179,14],[183,19,179,15,"error"],[183,24,179,14],[183,25,179,8],[184,0,180,7],[184,11,177,6],[185,0,181,5],[185,9,169,11],[185,10,169,4],[186,0,182,3],[189,13,191,2],[189,30,191,10,"id"],[189,32,191,2],[189,34,191,14],[190,0,192,4],[190,13,192,9,"_firestore"],[190,23,192,4],[190,24,192,20,"native"],[190,30,192,4],[190,31,192,27,"transactionDispose"],[190,49,192,4],[190,50,192,46,"id"],[190,52,192,4],[192,0,193,4],[192,15,193,11],[192,20,193,16,"_pending"],[192,28,193,11],[192,29,193,25,"id"],[192,31,193,11],[192,32,193,4],[193,0,194,3]],"functionMap":{"names":["<global>","generateTransactionId","FirestoreTransactionHandler","constructor","_onTransactionEvent","_handleUpdate","_handleError","_handleComplete","_add","Promise$argument_0","meta.resolve","meta.reject","_remove"],"mappings":"AAA;8BC2B,qBD;eEE;ECC;GDO;EEE;GFY;EGE;GHkD;EIQ;GJc;EKS;GLW;EMS;uBCc;qBCG;ODG;oBEE;OFG;KDC;GNC;EUS;GVG;CFC"}},"type":"js/module"}]}